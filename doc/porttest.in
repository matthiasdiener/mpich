#! /bin/sh
# This script is generated by configure for the purpose of reporting on
# the port of MPICH to a new architecture.  This runs ONLY the test programs
#
# To simplify testing and a few special cases, this script takes a few options
# -author="name"        Use instead of 'whoami'
# -nomake               Do not run make
# -noperf               Do not run performance tests
# -file=name            Output LaTeX file (default is doc/doc1.tex)
author="`whoami`"
nomake=0
noperf=0
filename="doc/doc1test.tex"
# This is the only portable way to get \b... into a file
write_beginex() {
    cat <<. >>$filename
\begin{example}
.
}
#
for arg in "$@" ; do
    case $arg in 
	-author=* )
	author="`echo $arg|sed 's/-author=//'`"
	;;
	-file=* )
	filebase=`echo $arg|sed 's/-file=//'`
        filename="${filebase}test.tex"
	;;
 	-nomake )
	nomake=1
	;;
 	-noperf )
	noperf=1
	;;
	*)
	if test -n "$arg" ; then 
	    echo "porttest: Unknown argument ($arg)"
	    exit 1
	fi
	;;
    esac
done
#
# Remove the old filename
/bin/rm -f $filename
#
############################################################################
# Some initial comments...
# sh is not reliable about processing redirects of stdin within if...else..fi
# For such cases, we place the output text within a routine, defined
# outside of the if..else..fi, and called conditionally.
############################################################################
cat <<. >> $filename 
\section{Test results}
MPICH comes with a collection of test programs in \file{examples/test}.  This
build of the MPICH MPI implementation ran the test programs.  The results
are given below.
.
#examples/test/coll/coll.diff, context/context.diff, env/env.diff, 
#pt2pt/pt2pt.diff
############################################################################
# Run the tests...
############################################################################
(cd examples/test ; make testing > test.log 2>&1 ) 
############################################################################
# Check the output...
############################################################################
if test -s examples/test/pt2pt/pt2pt.diff ; then
    echo "Errors detected in the point-to-point tests:" >> $filename
    write_beginex
    cat examples/test/pt2pt/pt2pt.diff >> $filename
    echo "\\end{example}" >> $filename
fi
if test -s examples/test/coll/coll.diff ; then
    echo "Errors detected in the collective tests:" >> $filename
    write_beginex
    cat examples/test/coll/coll.diff >> $filename
    echo "\\end{example}" >> $filename
fi
if test -s examples/test/context/context.diff ; then
    echo "Errors detected in the context/communicator tests:" >> $filename
    write_beginex
    cat examples/test/context/context.diff >> $filename
    echo "\\end{example}" >> $filename
fi
if test -s examples/test/env/env.diff ; then
    echo "Errors detected in the environment tests:" >> $filename
    write_beginex
    cat examples/test/env/env.diff >> $filename
    echo "\\end{example}" >> $filename
fi

#  (C) 1993 by Argonne National Laboratory and Mississipi State University.
#      All rights reserved.  See COPYRIGHT in top-level directory.
#

##### User configurable options #####

ARCH        = @ARCH@
MAKE        = @MAKE@
COMM        = @COMM@
MPIR_HOME   = @MPIR_HOME@
CC          = @MPICC@
CLINKER     = $(CC)
F77         = @MPIF77@
FLINKER     = $(F77)
AR          = @AR@
RANLIB      = @RANLIB@
INCLUDE_DIR = @X_INC@ -I@MPIR_HOME@/mpid/ch2
OPTFLAGS    = @OPTFLAGS@
MPE_GRAPH   = @MPE_GRAPHICS@
LIB_PATH    = @X_LIB@ -lmpe -lp@MPILIBNAME@
LIB_LIST    = 
LIB_DIR     = @LIB_DIR@

MPEGRAPHICS_SOURCE = @MPEGRAPHICS_SOURCE@
MPEGRAPHICS_OBJS   = @MPEGRAPHICS_OBJS@
MPEGRAPHICS_FSOURCE = @MPEGRAPHICS_FSOURCE@
MPEGRAPHICS_FOBJS   = @MPEGRAPHICS_FOBJS@
### End User configurable options ###
SHELL = /bin/sh

EXECS = dbxtest dbxtest2 printlog ctoalog testlog srtest

# GETNAME_DEFS are needed by mpehname.c
CFLAGS = @MPE_CFLAGS@ @GETNAME_DEFS@ \
	$(OPTFLAGS) $(INCLUDE_DIR) $(MPIPROFILE) \
	$(MPE_GRAPH)

MPE_CSOURCES =  timers.c  $(MPEGRAPHICS_SOURCE) clog_sysio.c mpe_log.c clog.c \
		clog_merge.c clog_time.c clog_util.c clog2alog.c decomp.c \
	       	mpe_seq.c examine.c privtags.c getgrank.c mpehname.c mpe_io.c
MPE_TSOURCES =  decomp.c mpe_seq.c dbxerr.c getgrank.c
MPE_COBJECTS =  timers.o  $(MPEGRAPHICS_OBJS) clog_sysio.o mpe_log.o clog.o \
		clog_merge.o clog_time.o clog_util.o clog2alog.o decomp.o \
		mpe_seq.o dbxerr.o examine.o privtags.o getgrank.o mpehname.o \
		mpe_io.o
MPE_WSOURCES = $(MPEGRAPHICS_FSOURCE) mpe_logf.c decompf.c mpe_seqf.c \
	       getgrankf.c
MPE_WOBJECTS = timersf.o $(MPEGRAPHICS_FOBJS) mpe_logf.o decompf.o mpe_seqf.o \
		getgrankf.o

MPE_SOURCES = $(MPE_CSOURCES) $(MPE_WSOURCES)
MPE_OBJECTS = $(MPE_COBJECTS) $(MPE_WOBJECTS)

# default_all is the same as default, but without the RANLIB.  This
# can speed up the build (ranlibs can take a LONG time).  profile_all 
# is the same, but for the profile library
# **** Currently the same as default for simplicity ****
default_all: default
profile_all: 

#
# libmpe_nompi must be last because some make's "optimize" by computing
# all dependencies at the beginning, rather than when each target is
# evaluated.  Since libmpe_nompi cleans the object files (to force a rebuild
# with the NO_MPI switch), this can cause problems.
default: $(LIB_DIR)/libmpe.a \
	 $(LIB_DIR)/mpe_prof.o \
	 $(LIB_DIR)/mpe_proff.o \
	 $(LIB_DIR)/libtmpi.a \
	 $(LIB_DIR)/liblmpi.a \
	 $(LIB_DIR)/libampi.a \
	 $(LIB_DIR)/libmpe_nompi.a

profile:
wrappers:
	$(MPIR_HOME)/util/bfort -ferr -mpi -mnative -mapptr -ptrprefix MPIR_ \
		-anyname -I pubinc $(MPE_TSOURCES)

#
# It is tempting here to use ... libmpe.a($(MPE_OBJECTS)) as the dependency,
# but this would require that all makes properly handle library dependencies.
# Since makes that DO are the exception rather than the rule, we don't
# use this form
$(LIB_DIR)/libmpe.a: $(MPE_OBJECTS)
	$(AR) $@ $?
	$(RANLIB) $@
#	-/bin/rm -f $?

$(LIB_DIR)/libmpe_nompi.a:  $(MPEGRAPHICS_SOURCE)
	@if [ "$(MPEGRAPHICS_SOURCE)" != "" ] ; then \
	    $(MAKE) clean ; \
	    $(MAKE) -f Makefile_nompi $@ ; \
	fi
manpages:
	$(MPIR_HOME)/util/doctext -mpath $(MPIR_HOME)/man/man4 \
	 -ext 4 -I pubinc -index $(MPIR_HOME)/www.mpe.index \
	 -jumpfile $(MPIR_HOME)/jumpfile.list \
	   -indexdir "http://www.mcs.anl.gov/mpi/man" -heading MPE \
		$(MPE_CSOURCES)
	$(MPIR_HOME)/util/doc2lt $(MPE_CSOURCES) >> $(MPIR_HOME)/rsummpe.tmp

wwwpages:
	../util/doctext -html -mpath ../www/www4 -ext html -I pubinc \
	   -index ../www.index -jumpfile ../jumpfile.list \
	   -mapref $(MPIR_HOME)/util/mpis.cit \
	   -indexdir "http://www.mcs.anl.gov/mpi/man" -heading MPE \
		-quotefmt ../util/fortnotes ../util/errnotes \
	$(MPE_CSOURCES)

mpe_log.o: mpe_log.h clog.h clog_merge.h
clog.o: clog.h clogimpl.h
clog_util.o: clog.h clogimpl.h
clog_merge.o: clog.h clogimpl.h clog_merge.h
clog2alog.o: clog.h clogimpl.h
printlog.o: clog.h clogimpl.h

mpe_plog.o: mpe_log.h mpe_log.c mpe_log_genproc.c mpe_log_genproc.h \
	  mpe_log_merge.c mpe_log_adjusttime.c
	$(CC) $(CFLAGS) -c -DUSE_PMPI mpe_log.c
	@/bin/mv mpe_log.o mpe_plog.o

$(LIB_DIR)/libtmpi.a: trc_wrappers.o
	$(AR) $@ $?
	$(RANLIB) $@
#	-/bin/rm -f $?

$(LIB_DIR)/liblmpi.a: log_wrap.o mpe_plog.o clog.o clog_util.o clog_merge.o \
                        clog2alog.o clog_time.o
	$(AR) $@ $?
	$(RANLIB) $@
#	-/bin/rm -f $?

$(LIB_DIR)/libampi.a: visual_mess.c
	if [ -n "@MPE_GRAPHICS@" ] ; then \
	$(CC) $(CFLAGS) -c visual_mess.c ; \
	$(AR) $@ visual_mess.o ; \
	$(RANLIB) $@ ; fi
#	-/bin/rm -f $?

.c.o:
	$(CC) $(CFLAGS) -c $*.c

.c.a:
	$(CC) $(CFLAGS) -c $*.c

$(LIB_DIR)/mpe_prof.o: mpe_prof.c
	$(CC) $(CFLAGS) -c mpe_prof.c
	@-if [ $(LIB_DIR) != "." ] ; then /bin/cp mpe_prof.o $(LIB_DIR) ; fi

$(LIB_DIR)/mpe_proff.o: mpe_proff.c
	$(CC) $(CFLAGS) -c mpe_proff.c
	@-if [ $(LIB_DIR) != "." ] ; then /bin/cp mpe_proff.o $(LIB_DIR) ; fi

dbxtest: dbxtest.o $(LIB_DIR)/libmpe.a
	$(CLINKER) -o dbxtest dbxtest.o \
		$(LIB_DIR)/libmpe.a \
		$(LIB_DIR)/lib@MPILIBNAME@.a \
		$(LIB_PATH) $(LIB_LIST)
dbxtest2: dbxtest2.o $(LIB_DIR)/libmpe.a
	$(CLINKER) -o dbxtest2 dbxtest2.o \
		$(LIB_DIR)/libmpe.a \
		$(LIB_DIR)/lib@MPILIBNAME@.a \
		$(LIB_PATH) $(LIB_LIST)
printlog: printlog.o clog.o clog_time.o clog_util.o clog_merge.o
	$(CLINKER) $(LDFLAGS) -o printlog printlog.o \
		$(LIB_DIR)/libmpe.a \
		$(LIB_DIR)/lib@MPILIBNAME@.a \
		$(LIB_PATH) $(LIB_LIST)
ctoalog: ctoalog.o clog2alog.o clog.o clog_time.o clog_merge.o
	$(CLINKER) $(LDFLAGS) -o ctoalog ctoalog.o clog2alog.o \
		$(LIB_DIR)/libmpe.a \
		$(LIB_DIR)/lib@MPILIBNAME@.a \
		$(LIB_PATH) $(LIB_LIST)
testlog.o: testlog.c clog.h clog_merge.h clog_time.h
	$(CC) $(CFLAGS) -c testlog.c
testlog: testlog.o clog.o clog_time.o clog_merge.o clog_util.o
	$(CLINKER) $(LDFLAGS) -o testlog testlog.o \
		$(LIB_DIR)/libmpe.a \
		$(LIB_DIR)/lib@MPILIBNAME@.a \
		$(LIB_PATH) $(LIB_LIST)
clean:
	-/bin/rm -f *.o *~ $(EXECS) PI*
	-(cd contrib/mandel ; $(MAKE) clean)
	-(cd contrib/mastermind ; $(MAKE) clean)
	-(cd contrib/life ; $(MAKE) clean)
	-(cd test ; $(MAKE) clean)


